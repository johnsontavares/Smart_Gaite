{"ast":null,"code":"import { __awaiter, __extends, __generator, __read } from \"tslib\";\nimport { CockroachDriver } from \"../driver/cockroachdb/CockroachDriver\";\nimport { SapDriver } from \"../driver/sap/SapDriver\";\nimport { QueryBuilder } from \"./QueryBuilder\";\nimport { SqlServerDriver } from \"../driver/sqlserver/SqlServerDriver\";\nimport { PostgresDriver } from \"../driver/postgres/PostgresDriver\";\nimport { EntityMetadata } from \"../metadata/EntityMetadata\";\nimport { UpdateResult } from \"./result/UpdateResult\";\nimport { ReturningStatementNotSupportedError } from \"../error/ReturningStatementNotSupportedError\";\nimport { ReturningResultsEntityUpdator } from \"./ReturningResultsEntityUpdator\";\nimport { SqljsDriver } from \"../driver/sqljs/SqljsDriver\";\nimport { MysqlDriver } from \"../driver/mysql/MysqlDriver\";\nimport { BroadcasterResult } from \"../subscriber/BroadcasterResult\";\nimport { AbstractSqliteDriver } from \"../driver/sqlite-abstract/AbstractSqliteDriver\";\nimport { LimitOnUpdateNotSupportedError } from \"../error/LimitOnUpdateNotSupportedError\";\nimport { OracleDriver } from \"../driver/oracle/OracleDriver\";\nimport { UpdateValuesMissingError } from \"../error/UpdateValuesMissingError\";\nimport { EntityColumnNotFound } from \"../error/EntityColumnNotFound\";\nimport { AuroraDataApiDriver } from \"../driver/aurora-data-api/AuroraDataApiDriver\";\nimport { BetterSqlite3Driver } from \"../driver/better-sqlite3/BetterSqlite3Driver\";\n/**\n * Allows to build complex sql queries in a fashion way and execute those queries.\n */\n\nvar UpdateQueryBuilder =\n/** @class */\nfunction (_super) {\n  __extends(UpdateQueryBuilder, _super); // -------------------------------------------------------------------------\n  // Constructor\n  // -------------------------------------------------------------------------\n\n\n  function UpdateQueryBuilder(connectionOrQueryBuilder, queryRunner) {\n    var _this = _super.call(this, connectionOrQueryBuilder, queryRunner) || this;\n\n    _this.expressionMap.aliasNamePrefixingEnabled = false;\n    return _this;\n  } // -------------------------------------------------------------------------\n  // Public Implemented Methods\n  // -------------------------------------------------------------------------\n\n  /**\n   * Gets generated sql query without parameters being replaced.\n   */\n\n\n  UpdateQueryBuilder.prototype.getQuery = function () {\n    var sql = this.createComment();\n    sql += this.createUpdateExpression();\n    sql += this.createOrderByExpression();\n    sql += this.createLimitExpression();\n    return sql.trim();\n  };\n  /**\n   * Executes sql generated by query builder and returns raw database results.\n   */\n\n\n  UpdateQueryBuilder.prototype.execute = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var queryRunner, transactionStartedByUs, broadcastResult, declareSql, selectOutputSql, returningResultsEntityUpdator, _a, updateSql, parameters, updateResult, statements, result, broadcastResult, error_1, rollbackError_1;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            queryRunner = this.obtainQueryRunner();\n            transactionStartedByUs = false;\n            _b.label = 1;\n\n          case 1:\n            _b.trys.push([1, 13, 18, 23]);\n\n            if (!(this.expressionMap.useTransaction === true && queryRunner.isTransactionActive === false)) return [3\n            /*break*/\n            , 3];\n            return [4\n            /*yield*/\n            , queryRunner.startTransaction()];\n\n          case 2:\n            _b.sent();\n\n            transactionStartedByUs = true;\n            _b.label = 3;\n\n          case 3:\n            if (!(this.expressionMap.callListeners === true && this.expressionMap.mainAlias.hasMetadata)) return [3\n            /*break*/\n            , 5];\n            broadcastResult = new BroadcasterResult();\n            queryRunner.broadcaster.broadcastBeforeUpdateEvent(broadcastResult, this.expressionMap.mainAlias.metadata, this.expressionMap.valuesSet);\n            if (!(broadcastResult.promises.length > 0)) return [3\n            /*break*/\n            , 5];\n            return [4\n            /*yield*/\n            , Promise.all(broadcastResult.promises)];\n\n          case 4:\n            _b.sent();\n\n            _b.label = 5;\n\n          case 5:\n            declareSql = null;\n            selectOutputSql = null;\n            returningResultsEntityUpdator = new ReturningResultsEntityUpdator(queryRunner, this.expressionMap);\n\n            if (this.expressionMap.updateEntity === true && this.expressionMap.mainAlias.hasMetadata && this.expressionMap.whereEntities.length > 0) {\n              this.expressionMap.extraReturningColumns = returningResultsEntityUpdator.getUpdationReturningColumns();\n\n              if (this.expressionMap.extraReturningColumns.length > 0 && this.connection.driver instanceof SqlServerDriver) {\n                declareSql = this.connection.driver.buildTableVariableDeclaration(\"@OutputTable\", this.expressionMap.extraReturningColumns);\n                selectOutputSql = \"SELECT * FROM @OutputTable\";\n              }\n            }\n\n            _a = __read(this.getQueryAndParameters(), 2), updateSql = _a[0], parameters = _a[1];\n            updateResult = new UpdateResult();\n            statements = [declareSql, updateSql, selectOutputSql];\n            return [4\n            /*yield*/\n            , queryRunner.query(statements.filter(function (sql) {\n              return sql != null;\n            }).join(\";\\n\\n\"), parameters)];\n\n          case 6:\n            result = _b.sent();\n\n            if (this.connection.driver instanceof PostgresDriver) {\n              updateResult.raw = result[0];\n              updateResult.affected = result[1];\n            } else if (this.connection.driver instanceof MysqlDriver) {\n              updateResult.raw = result;\n              updateResult.affected = result.affectedRows;\n            } else if (this.connection.driver instanceof AuroraDataApiDriver) {\n              updateResult.raw = result;\n              updateResult.affected = result.numberOfRecordsUpdated;\n            } else if (this.connection.driver instanceof BetterSqlite3Driver) {\n              // only works for better-sqlite3\n              updateResult.raw = result;\n              updateResult.affected = result.changes;\n            } else {\n              updateResult.raw = result;\n            }\n\n            if (!(this.expressionMap.updateEntity === true && this.expressionMap.mainAlias.hasMetadata && this.expressionMap.whereEntities.length > 0)) return [3\n            /*break*/\n            , 8];\n            return [4\n            /*yield*/\n            , returningResultsEntityUpdator.update(updateResult, this.expressionMap.whereEntities)];\n\n          case 7:\n            _b.sent();\n\n            _b.label = 8;\n\n          case 8:\n            if (!(this.expressionMap.callListeners === true && this.expressionMap.mainAlias.hasMetadata)) return [3\n            /*break*/\n            , 10];\n            broadcastResult = new BroadcasterResult();\n            queryRunner.broadcaster.broadcastAfterUpdateEvent(broadcastResult, this.expressionMap.mainAlias.metadata);\n            if (!(broadcastResult.promises.length > 0)) return [3\n            /*break*/\n            , 10];\n            return [4\n            /*yield*/\n            , Promise.all(broadcastResult.promises)];\n\n          case 9:\n            _b.sent();\n\n            _b.label = 10;\n\n          case 10:\n            if (!transactionStartedByUs) return [3\n            /*break*/\n            , 12];\n            return [4\n            /*yield*/\n            , queryRunner.commitTransaction()];\n\n          case 11:\n            _b.sent();\n\n            _b.label = 12;\n\n          case 12:\n            return [2\n            /*return*/\n            , updateResult];\n\n          case 13:\n            error_1 = _b.sent();\n            if (!transactionStartedByUs) return [3\n            /*break*/\n            , 17];\n            _b.label = 14;\n\n          case 14:\n            _b.trys.push([14, 16,, 17]);\n\n            return [4\n            /*yield*/\n            , queryRunner.rollbackTransaction()];\n\n          case 15:\n            _b.sent();\n\n            return [3\n            /*break*/\n            , 17];\n\n          case 16:\n            rollbackError_1 = _b.sent();\n            return [3\n            /*break*/\n            , 17];\n\n          case 17:\n            throw error_1;\n\n          case 18:\n            if (!(queryRunner !== this.queryRunner)) return [3\n            /*break*/\n            , 20];\n            return [4\n            /*yield*/\n            , queryRunner.release()];\n\n          case 19:\n            _b.sent();\n\n            _b.label = 20;\n\n          case 20:\n            if (!(this.connection.driver instanceof SqljsDriver && !queryRunner.isTransactionActive)) return [3\n            /*break*/\n            , 22];\n            return [4\n            /*yield*/\n            , this.connection.driver.autoSave()];\n\n          case 21:\n            _b.sent();\n\n            _b.label = 22;\n\n          case 22:\n            return [7\n            /*endfinally*/\n            ];\n\n          case 23:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  }; // -------------------------------------------------------------------------\n  // Public Methods\n  // -------------------------------------------------------------------------\n\n  /**\n   * Values needs to be updated.\n   */\n\n\n  UpdateQueryBuilder.prototype.set = function (values) {\n    this.expressionMap.valuesSet = values;\n    return this;\n  };\n  /**\n   * Sets WHERE condition in the query builder.\n   * If you had previously WHERE expression defined,\n   * calling this function will override previously set WHERE conditions.\n   * Additionally you can add parameters used in where expression.\n   */\n\n\n  UpdateQueryBuilder.prototype.where = function (where, parameters) {\n    this.expressionMap.wheres = []; // don't move this block below since computeWhereParameter can add where expressions\n\n    var condition = this.computeWhereParameter(where);\n    if (condition) this.expressionMap.wheres = [{\n      type: \"simple\",\n      condition: condition\n    }];\n    if (parameters) this.setParameters(parameters);\n    return this;\n  };\n  /**\n   * Adds new AND WHERE condition in the query builder.\n   * Additionally you can add parameters used in where expression.\n   */\n\n\n  UpdateQueryBuilder.prototype.andWhere = function (where, parameters) {\n    this.expressionMap.wheres.push({\n      type: \"and\",\n      condition: this.computeWhereParameter(where)\n    });\n    if (parameters) this.setParameters(parameters);\n    return this;\n  };\n  /**\n   * Adds new OR WHERE condition in the query builder.\n   * Additionally you can add parameters used in where expression.\n   */\n\n\n  UpdateQueryBuilder.prototype.orWhere = function (where, parameters) {\n    this.expressionMap.wheres.push({\n      type: \"or\",\n      condition: this.computeWhereParameter(where)\n    });\n    if (parameters) this.setParameters(parameters);\n    return this;\n  };\n  /**\n   * Adds new AND WHERE with conditions for the given ids.\n   */\n\n\n  UpdateQueryBuilder.prototype.whereInIds = function (ids) {\n    return this.where(this.createWhereIdsExpression(ids));\n  };\n  /**\n   * Adds new AND WHERE with conditions for the given ids.\n   */\n\n\n  UpdateQueryBuilder.prototype.andWhereInIds = function (ids) {\n    return this.andWhere(this.createWhereIdsExpression(ids));\n  };\n  /**\n   * Adds new OR WHERE with conditions for the given ids.\n   */\n\n\n  UpdateQueryBuilder.prototype.orWhereInIds = function (ids) {\n    return this.orWhere(this.createWhereIdsExpression(ids));\n  };\n  /**\n   * Optional returning/output clause.\n   */\n\n\n  UpdateQueryBuilder.prototype.output = function (output) {\n    return this.returning(output);\n  };\n  /**\n   * Optional returning/output clause.\n   */\n\n\n  UpdateQueryBuilder.prototype.returning = function (returning) {\n    // not all databases support returning/output cause\n    if (!this.connection.driver.isReturningSqlSupported()) throw new ReturningStatementNotSupportedError();\n    this.expressionMap.returning = returning;\n    return this;\n  };\n  /**\n   * Sets ORDER BY condition in the query builder.\n   * If you had previously ORDER BY expression defined,\n   * calling this function will override previously set ORDER BY conditions.\n   */\n\n\n  UpdateQueryBuilder.prototype.orderBy = function (sort, order, nulls) {\n    var _a, _b;\n\n    if (order === void 0) {\n      order = \"ASC\";\n    }\n\n    if (sort) {\n      if (sort instanceof Object) {\n        this.expressionMap.orderBys = sort;\n      } else {\n        if (nulls) {\n          this.expressionMap.orderBys = (_a = {}, _a[sort] = {\n            order: order,\n            nulls: nulls\n          }, _a);\n        } else {\n          this.expressionMap.orderBys = (_b = {}, _b[sort] = order, _b);\n        }\n      }\n    } else {\n      this.expressionMap.orderBys = {};\n    }\n\n    return this;\n  };\n  /**\n   * Adds ORDER BY condition in the query builder.\n   */\n\n\n  UpdateQueryBuilder.prototype.addOrderBy = function (sort, order, nulls) {\n    if (order === void 0) {\n      order = \"ASC\";\n    }\n\n    if (nulls) {\n      this.expressionMap.orderBys[sort] = {\n        order: order,\n        nulls: nulls\n      };\n    } else {\n      this.expressionMap.orderBys[sort] = order;\n    }\n\n    return this;\n  };\n  /**\n   * Sets LIMIT - maximum number of rows to be selected.\n   */\n\n\n  UpdateQueryBuilder.prototype.limit = function (limit) {\n    this.expressionMap.limit = limit;\n    return this;\n  };\n  /**\n   * Indicates if entity must be updated after update operation.\n   * This may produce extra query or use RETURNING / OUTPUT statement (depend on database).\n   * Enabled by default.\n   */\n\n\n  UpdateQueryBuilder.prototype.whereEntity = function (entity) {\n    var _this = this;\n\n    if (!this.expressionMap.mainAlias.hasMetadata) throw new Error(\".whereEntity method can only be used on queries which update real entity table.\");\n    this.expressionMap.wheres = [];\n    var entities = Array.isArray(entity) ? entity : [entity];\n    entities.forEach(function (entity) {\n      var entityIdMap = _this.expressionMap.mainAlias.metadata.getEntityIdMap(entity);\n\n      if (!entityIdMap) throw new Error(\"Provided entity does not have ids set, cannot perform operation.\");\n\n      _this.orWhereInIds(entityIdMap);\n    });\n    this.expressionMap.whereEntities = entities;\n    return this;\n  };\n  /**\n   * Indicates if entity must be updated after update operation.\n   * This may produce extra query or use RETURNING / OUTPUT statement (depend on database).\n   * Enabled by default.\n   */\n\n\n  UpdateQueryBuilder.prototype.updateEntity = function (enabled) {\n    this.expressionMap.updateEntity = enabled;\n    return this;\n  }; // -------------------------------------------------------------------------\n  // Protected Methods\n  // -------------------------------------------------------------------------\n\n  /**\n   * Creates UPDATE express used to perform insert query.\n   */\n\n\n  UpdateQueryBuilder.prototype.createUpdateExpression = function () {\n    var _this = this;\n\n    var valuesSet = this.getValueSet();\n    var metadata = this.expressionMap.mainAlias.hasMetadata ? this.expressionMap.mainAlias.metadata : undefined; // prepare columns and values to be updated\n\n    var updateColumnAndValues = [];\n    var updatedColumns = [];\n    var newParameters = {};\n    var parametersCount = this.connection.driver instanceof MysqlDriver || this.connection.driver instanceof AuroraDataApiDriver || this.connection.driver instanceof OracleDriver || this.connection.driver instanceof AbstractSqliteDriver || this.connection.driver instanceof SapDriver ? 0 : Object.keys(this.expressionMap.nativeParameters).length;\n\n    if (metadata) {\n      EntityMetadata.createPropertyPath(metadata, valuesSet).forEach(function (propertyPath) {\n        // todo: make this and other query builder to work with properly with tables without metadata\n        var columns = metadata.findColumnsWithPropertyPath(propertyPath);\n\n        if (columns.length <= 0) {\n          throw new EntityColumnNotFound(propertyPath);\n        }\n\n        columns.forEach(function (column) {\n          if (!column.isUpdate) {\n            return;\n          }\n\n          updatedColumns.push(column);\n          var paramName = \"upd_\" + column.databaseName; //\n\n          var value = column.getEntityValue(valuesSet);\n\n          if (column.referencedColumn && value instanceof Object) {\n            value = column.referencedColumn.getEntityValue(value);\n          } else if (!(value instanceof Function)) {\n            value = _this.connection.driver.preparePersistentValue(value, column);\n          } // todo: duplication zone\n\n\n          if (value instanceof Function) {\n            // support for SQL expressions in update query\n            updateColumnAndValues.push(_this.escape(column.databaseName) + \" = \" + value());\n          } else if (_this.connection.driver instanceof SapDriver && value === null) {\n            updateColumnAndValues.push(_this.escape(column.databaseName) + \" = NULL\");\n          } else {\n            if (_this.connection.driver instanceof SqlServerDriver) {\n              value = _this.connection.driver.parametrizeValue(column, value); // } else if (value instanceof Array) {\n              //     value = new ArrayParameter(value);\n            }\n\n            if (_this.connection.driver instanceof MysqlDriver || _this.connection.driver instanceof AuroraDataApiDriver || _this.connection.driver instanceof OracleDriver || _this.connection.driver instanceof AbstractSqliteDriver || _this.connection.driver instanceof SapDriver) {\n              newParameters[paramName] = value;\n            } else {\n              _this.expressionMap.nativeParameters[paramName] = value;\n            }\n\n            var expression = null;\n\n            if ((_this.connection.driver instanceof MysqlDriver || _this.connection.driver instanceof AuroraDataApiDriver) && _this.connection.driver.spatialTypes.indexOf(column.type) !== -1) {\n              var useLegacy = _this.connection.driver.options.legacySpatialSupport;\n              var geomFromText = useLegacy ? \"GeomFromText\" : \"ST_GeomFromText\";\n\n              if (column.srid != null) {\n                expression = geomFromText + \"(\" + _this.connection.driver.createParameter(paramName, parametersCount) + \", \" + column.srid + \")\";\n              } else {\n                expression = geomFromText + \"(\" + _this.connection.driver.createParameter(paramName, parametersCount) + \")\";\n              }\n            } else if (_this.connection.driver instanceof PostgresDriver && _this.connection.driver.spatialTypes.indexOf(column.type) !== -1) {\n              if (column.srid != null) {\n                expression = \"ST_SetSRID(ST_GeomFromGeoJSON(\" + _this.connection.driver.createParameter(paramName, parametersCount) + \"), \" + column.srid + \")::\" + column.type;\n              } else {\n                expression = \"ST_GeomFromGeoJSON(\" + _this.connection.driver.createParameter(paramName, parametersCount) + \")::\" + column.type;\n              }\n            } else if (_this.connection.driver instanceof SqlServerDriver && _this.connection.driver.spatialTypes.indexOf(column.type) !== -1) {\n              expression = column.type + \"::STGeomFromText(\" + _this.connection.driver.createParameter(paramName, parametersCount) + \", \" + (column.srid || \"0\") + \")\";\n            } else {\n              expression = _this.connection.driver.createParameter(paramName, parametersCount);\n            }\n\n            updateColumnAndValues.push(_this.escape(column.databaseName) + \" = \" + expression);\n            parametersCount++;\n          }\n        });\n      });\n      if (metadata.versionColumn && updatedColumns.indexOf(metadata.versionColumn) === -1) updateColumnAndValues.push(this.escape(metadata.versionColumn.databaseName) + \" = \" + this.escape(metadata.versionColumn.databaseName) + \" + 1\");\n      if (metadata.updateDateColumn && updatedColumns.indexOf(metadata.updateDateColumn) === -1) updateColumnAndValues.push(this.escape(metadata.updateDateColumn.databaseName) + \" = CURRENT_TIMESTAMP\"); // todo: fix issue with CURRENT_TIMESTAMP(6) being used, can \"DEFAULT\" be used?!\n    } else {\n      Object.keys(valuesSet).map(function (key) {\n        var value = valuesSet[key]; // todo: duplication zone\n\n        if (value instanceof Function) {\n          // support for SQL expressions in update query\n          updateColumnAndValues.push(_this.escape(key) + \" = \" + value());\n        } else if (_this.connection.driver instanceof SapDriver && value === null) {\n          updateColumnAndValues.push(_this.escape(key) + \" = NULL\");\n        } else {\n          // we need to store array values in a special class to make sure parameter replacement will work correctly\n          // if (value instanceof Array)\n          //     value = new ArrayParameter(value);\n          if (_this.connection.driver instanceof MysqlDriver || _this.connection.driver instanceof AuroraDataApiDriver || _this.connection.driver instanceof OracleDriver || _this.connection.driver instanceof AbstractSqliteDriver || _this.connection.driver instanceof SapDriver) {\n            newParameters[key] = value;\n          } else {\n            _this.expressionMap.nativeParameters[key] = value;\n          }\n\n          updateColumnAndValues.push(_this.escape(key) + \" = \" + _this.connection.driver.createParameter(key, parametersCount));\n          parametersCount++;\n        }\n      });\n    }\n\n    if (updateColumnAndValues.length <= 0) {\n      throw new UpdateValuesMissingError();\n    } // we re-write parameters this way because we want our \"UPDATE ... SET\" parameters to be first in the list of \"nativeParameters\"\n    // because some drivers like mysql depend on order of parameters\n\n\n    if (this.connection.driver instanceof MysqlDriver || this.connection.driver instanceof AuroraDataApiDriver || this.connection.driver instanceof OracleDriver || this.connection.driver instanceof AbstractSqliteDriver || this.connection.driver instanceof SapDriver) {\n      this.expressionMap.nativeParameters = Object.assign(newParameters, this.expressionMap.nativeParameters);\n    } // get a table name and all column database names\n\n\n    var whereExpression = this.createWhereExpression();\n    var returningExpression = this.createReturningExpression(); // generate and return sql update query\n\n    if (returningExpression && (this.connection.driver instanceof PostgresDriver || this.connection.driver instanceof OracleDriver || this.connection.driver instanceof CockroachDriver)) {\n      return \"UPDATE \" + this.getTableName(this.getMainTableName()) + \" SET \" + updateColumnAndValues.join(\", \") + whereExpression + \" RETURNING \" + returningExpression;\n    } else if (returningExpression && this.connection.driver instanceof SqlServerDriver) {\n      return \"UPDATE \" + this.getTableName(this.getMainTableName()) + \" SET \" + updateColumnAndValues.join(\", \") + \" OUTPUT \" + returningExpression + whereExpression;\n    } else {\n      return \"UPDATE \" + this.getTableName(this.getMainTableName()) + \" SET \" + updateColumnAndValues.join(\", \") + whereExpression; // todo: how do we replace aliases in where to nothing?\n    }\n  };\n  /**\n   * Creates \"ORDER BY\" part of SQL query.\n   */\n\n\n  UpdateQueryBuilder.prototype.createOrderByExpression = function () {\n    var _this = this;\n\n    var orderBys = this.expressionMap.orderBys;\n    if (Object.keys(orderBys).length > 0) return \" ORDER BY \" + Object.keys(orderBys).map(function (columnName) {\n      if (typeof orderBys[columnName] === \"string\") {\n        return _this.replacePropertyNames(columnName) + \" \" + orderBys[columnName];\n      } else {\n        return _this.replacePropertyNames(columnName) + \" \" + orderBys[columnName].order + \" \" + orderBys[columnName].nulls;\n      }\n    }).join(\", \");\n    return \"\";\n  };\n  /**\n   * Creates \"LIMIT\" parts of SQL query.\n   */\n\n\n  UpdateQueryBuilder.prototype.createLimitExpression = function () {\n    var limit = this.expressionMap.limit;\n\n    if (limit) {\n      if (this.connection.driver instanceof MysqlDriver || this.connection.driver instanceof AuroraDataApiDriver) {\n        return \" LIMIT \" + limit;\n      } else {\n        throw new LimitOnUpdateNotSupportedError();\n      }\n    }\n\n    return \"\";\n  };\n  /**\n   * Gets array of values need to be inserted into the target table.\n   */\n\n\n  UpdateQueryBuilder.prototype.getValueSet = function () {\n    if (this.expressionMap.valuesSet instanceof Object) return this.expressionMap.valuesSet;\n    throw new UpdateValuesMissingError();\n  };\n\n  return UpdateQueryBuilder;\n}(QueryBuilder);\n\nexport { UpdateQueryBuilder };","map":{"version":3,"sources":["../browser/src/query-builder/UpdateQueryBuilder.ts"],"names":[],"mappings":";AAAA,SAAQ,eAAR,QAA8B,uCAA9B;AACA,SAAQ,SAAR,QAAwB,yBAAxB;AAEA,SAAQ,YAAR,QAA2B,gBAA3B;AAIA,SAAQ,eAAR,QAA8B,qCAA9B;AACA,SAAQ,cAAR,QAA6B,mCAA7B;AAGA,SAAQ,cAAR,QAA6B,4BAA7B;AACA,SAAQ,YAAR,QAA2B,uBAA3B;AACA,SAAQ,mCAAR,QAAkD,8CAAlD;AACA,SAAQ,6BAAR,QAA4C,iCAA5C;AACA,SAAQ,WAAR,QAA0B,6BAA1B;AACA,SAAQ,WAAR,QAA0B,6BAA1B;AACA,SAAQ,iBAAR,QAAgC,iCAAhC;AACA,SAAQ,oBAAR,QAAmC,gDAAnC;AAEA,SAAQ,8BAAR,QAA6C,yCAA7C;AACA,SAAQ,YAAR,QAA2B,+BAA3B;AACA,SAAQ,wBAAR,QAAuC,mCAAvC;AACA,SAAQ,oBAAR,QAAmC,+BAAnC;AAEA,SAAQ,mBAAR,QAAkC,+CAAlC;AACA,SAAQ,mBAAR,QAAkC,8CAAlC;AAEA;;AAEG;;AACH,IAAA,kBAAA;AAAA;AAAA,UAAA,MAAA,EAAA;AAAgD,EAAA,SAAA,CAAA,kBAAA,EAAA,MAAA,CAAA,CAAhD,CAEI;AACA;AACA;;;AAEA,WAAA,kBAAA,CAAY,wBAAZ,EAAoE,WAApE,EAA6F;AAA7F,QAAA,KAAA,GACI,MAAA,CAAA,IAAA,CAAA,IAAA,EAAM,wBAAN,EAAuC,WAAvC,KAAmD,IADvD;;AAEI,IAAA,KAAI,CAAC,aAAL,CAAmB,yBAAnB,GAA+C,KAA/C;;AACH,GATL,CAWI;AACA;AACA;;AAEA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,QAAA,GAAA,YAAA;AACI,QAAI,GAAG,GAAG,KAAK,aAAL,EAAV;AACA,IAAA,GAAG,IAAI,KAAK,sBAAL,EAAP;AACA,IAAA,GAAG,IAAI,KAAK,uBAAL,EAAP;AACA,IAAA,GAAG,IAAI,KAAK,qBAAL,EAAP;AACA,WAAO,GAAG,CAAC,IAAJ,EAAP;AACH,GAND;AAQA;;AAEG;;;AACG,EAAA,kBAAA,CAAA,SAAA,CAAA,OAAA,GAAN,YAAA;;;;;;;AACU,YAAA,WAAW,GAAG,KAAK,iBAAL,EAAd;AACF,YAAA,sBAAsB,GAAY,KAAlC;;;;;;gBAKI,EAAA,KAAK,aAAL,CAAmB,cAAnB,KAAsC,IAAtC,IAA8C,WAAW,CAAC,mBAAZ,KAAoC,KAAlF,C,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,CAAA,CAAA;AACA,mBAAA,CAAA;AAAA;AAAA,cAAM,WAAW,CAAC,gBAAZ,EAAN,CAAA;;;AAAA,YAAA,EAAA,CAAA,IAAA;;AACA,YAAA,sBAAsB,GAAG,IAAzB;;;;gBAIA,EAAA,KAAK,aAAL,CAAmB,aAAnB,KAAqC,IAArC,IAA6C,KAAK,aAAL,CAAmB,SAAnB,CAA8B,WAA3E,C,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,CAAA,CAAA;AACM,YAAA,eAAe,GAAG,IAAI,iBAAJ,EAAlB;AACN,YAAA,WAAW,CAAC,WAAZ,CAAwB,0BAAxB,CAAmD,eAAnD,EAAoE,KAAK,aAAL,CAAmB,SAAnB,CAA8B,QAAlG,EAA4G,KAAK,aAAL,CAAmB,SAA/H;gBACI,EAAA,eAAe,CAAC,QAAhB,CAAyB,MAAzB,GAAkC,CAAlC,C,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,CAAA,CAAA;AAAqC,mBAAA,CAAA;AAAA;AAAA,cAAM,OAAO,CAAC,GAAR,CAAY,eAAe,CAAC,QAA5B,CAAN,CAAA;;;AAAA,YAAA,EAAA,CAAA,IAAA;;;;;AAGzC,YAAA,UAAU,GAAkB,IAA5B;AACA,YAAA,eAAe,GAAkB,IAAjC;AAGE,YAAA,6BAA6B,GAAG,IAAI,6BAAJ,CAAkC,WAAlC,EAA+C,KAAK,aAApD,CAAhC;;AACN,gBAAI,KAAK,aAAL,CAAmB,YAAnB,KAAoC,IAApC,IACA,KAAK,aAAL,CAAmB,SAAnB,CAA8B,WAD9B,IAEA,KAAK,aAAL,CAAmB,aAAnB,CAAiC,MAAjC,GAA0C,CAF9C,EAEiD;AAC7C,mBAAK,aAAL,CAAmB,qBAAnB,GAA2C,6BAA6B,CAAC,2BAA9B,EAA3C;;AAEA,kBAAI,KAAK,aAAL,CAAmB,qBAAnB,CAAyC,MAAzC,GAAkD,CAAlD,IAAuD,KAAK,UAAL,CAAgB,MAAhB,YAAkC,eAA7F,EAA8G;AAC1G,gBAAA,UAAU,GAAG,KAAK,UAAL,CAAgB,MAAhB,CAAuB,6BAAvB,CAAqD,cAArD,EAAqE,KAAK,aAAL,CAAmB,qBAAxF,CAAb;AACA,gBAAA,eAAe,GAAG,4BAAlB;AACH;AACJ;;AAGK,YAAA,EAAA,GAAA,MAAA,CAA0B,KAAK,qBAAL,EAA1B,EAAsD,CAAtD,CAAA,EAAC,SAAS,GAAA,EAAA,CAAA,CAAA,CAAV,EAAY,UAAU,GAAA,EAAA,CAAA,CAAA,CAAtB;AACA,YAAA,YAAY,GAAG,IAAI,YAAJ,EAAf;AACA,YAAA,UAAU,GAAG,CAAC,UAAD,EAAa,SAAb,EAAwB,eAAxB,CAAb;AACS,mBAAA,CAAA;AAAA;AAAA,cAAM,WAAW,CAAC,KAAZ,CACjB,UAAU,CAAC,MAAX,CAAkB,UAAA,GAAA,EAAG;AAAI,qBAAA,GAAG,IAAH,IAAA;AAAW,aAApC,EAAsC,IAAtC,CAA2C,OAA3C,CADiB,EAEjB,UAFiB,CAAN,CAAA;;;AAAT,YAAA,MAAM,GAAG,EAAA,CAAA,IAAA,EAAT;;AAKN,gBAAI,KAAK,UAAL,CAAgB,MAAhB,YAAkC,cAAtC,EAAsD;AAClD,cAAA,YAAY,CAAC,GAAb,GAAmB,MAAM,CAAC,CAAD,CAAzB;AACA,cAAA,YAAY,CAAC,QAAb,GAAwB,MAAM,CAAC,CAAD,CAA9B;AACH,aAHD,MAIK,IAAI,KAAK,UAAL,CAAgB,MAAhB,YAAkC,WAAtC,EAAmD;AACpD,cAAA,YAAY,CAAC,GAAb,GAAmB,MAAnB;AACA,cAAA,YAAY,CAAC,QAAb,GAAwB,MAAM,CAAC,YAA/B;AACH,aAHI,MAIA,IAAI,KAAK,UAAL,CAAgB,MAAhB,YAAkC,mBAAtC,EAA2D;AAC5D,cAAA,YAAY,CAAC,GAAb,GAAmB,MAAnB;AACA,cAAA,YAAY,CAAC,QAAb,GAAwB,MAAM,CAAC,sBAA/B;AACH,aAHI,MAIA,IAAI,KAAK,UAAL,CAAgB,MAAhB,YAAkC,mBAAtC,EAA2D;AAAE;AAC9D,cAAA,YAAY,CAAC,GAAb,GAAmB,MAAnB;AACA,cAAA,YAAY,CAAC,QAAb,GAAwB,MAAM,CAAC,OAA/B;AACH,aAHI,MAIA;AACD,cAAA,YAAY,CAAC,GAAb,GAAmB,MAAnB;AACH;;gBAGG,EAAA,KAAK,aAAL,CAAmB,YAAnB,KAAoC,IAApC,IACA,KAAK,aAAL,CAAmB,SAAnB,CAA8B,WAD9B,IAEA,KAAK,aAAL,CAAmB,aAAnB,CAAiC,MAAjC,GAA0C,CAF1C,C,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,CAAA,CAAA;AAGA,mBAAA,CAAA;AAAA;AAAA,cAAM,6BAA6B,CAAC,MAA9B,CAAqC,YAArC,EAAmD,KAAK,aAAL,CAAmB,aAAtE,CAAN,CAAA;;;AAAA,YAAA,EAAA,CAAA,IAAA;;;;;gBAIA,EAAA,KAAK,aAAL,CAAmB,aAAnB,KAAqC,IAArC,IAA6C,KAAK,aAAL,CAAmB,SAAnB,CAA8B,WAA3E,C,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,EAAA,CAAA;AACM,YAAA,eAAe,GAAG,IAAI,iBAAJ,EAAlB;AACN,YAAA,WAAW,CAAC,WAAZ,CAAwB,yBAAxB,CAAkD,eAAlD,EAAmE,KAAK,aAAL,CAAmB,SAAnB,CAA8B,QAAjG;gBACI,EAAA,eAAe,CAAC,QAAhB,CAAyB,MAAzB,GAAkC,CAAlC,C,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,EAAA,CAAA;AAAqC,mBAAA,CAAA;AAAA;AAAA,cAAM,OAAO,CAAC,GAAR,CAAY,eAAe,CAAC,QAA5B,CAAN,CAAA;;;AAAA,YAAA,EAAA,CAAA,IAAA;;;;;iBAIzC,sB,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,EAAA,CAAA;AACA,mBAAA,CAAA;AAAA;AAAA,cAAM,WAAW,CAAC,iBAAZ,EAAN,CAAA;;;AAAA,YAAA,EAAA,CAAA,IAAA;;;;;AAEJ,mBAAA,CAAA;AAAA;AAAA,cAAO,YAAP,CAAA;;;;iBAKI,sB,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,EAAA,CAAA;;;;;;AAEI,mBAAA,CAAA;AAAA;AAAA,cAAM,WAAW,CAAC,mBAAZ,EAAN,CAAA;;;AAAA,YAAA,EAAA,CAAA,IAAA;;;;;;;;;;;;;AAGR,kBAAM,OAAN;;;gBAGI,EAAA,WAAW,KAAK,KAAK,WAArB,C,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,EAAA,CAAA;AACA,mBAAA,CAAA;AAAA;AAAA,cAAM,WAAW,CAAC,OAAZ,EAAN,CAAA;;;AAAA,YAAA,EAAA,CAAA,IAAA;;;;;gBAEA,EAAA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,WAAlC,IAAiD,CAAC,WAAW,CAAC,mBAA9D,C,EAAA,OAAA,CAAA;AAAA;AAAA,cAAA,EAAA,CAAA;AACA,mBAAA,CAAA;AAAA;AAAA,cAAM,KAAK,UAAL,CAAgB,MAAhB,CAAuB,QAAvB,EAAN,CAAA;;;AAAA,YAAA,EAAA,CAAA,IAAA;;;;;;;;;;;;;;;;AAGX,GAtGK,CA7BV,CAqII;AACA;AACA;;AAEA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,GAAA,GAAA,UAAI,MAAJ,EAA0C;AACtC,SAAK,aAAL,CAAmB,SAAnB,GAA+B,MAA/B;AACA,WAAO,IAAP;AACH,GAHD;AAKA;;;;;AAKG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,KAAA,GAAA,UAAM,KAAN,EAAmF,UAAnF,EAA6G;AACzG,SAAK,aAAL,CAAmB,MAAnB,GAA4B,EAA5B,CADyG,CACzE;;AAChC,QAAM,SAAS,GAAG,KAAK,qBAAL,CAA2B,KAA3B,CAAlB;AACA,QAAI,SAAJ,EACI,KAAK,aAAL,CAAmB,MAAnB,GAA4B,CAAC;AAAE,MAAA,IAAI,EAAE,QAAR;AAAkB,MAAA,SAAS,EAAE;AAA7B,KAAD,CAA5B;AACJ,QAAI,UAAJ,EACI,KAAK,aAAL,CAAmB,UAAnB;AACJ,WAAO,IAAP;AACH,GARD;AAUA;;;AAGG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,QAAA,GAAA,UAAS,KAAT,EAAwD,UAAxD,EAAkF;AAC9E,SAAK,aAAL,CAAmB,MAAnB,CAA0B,IAA1B,CAA+B;AAAE,MAAA,IAAI,EAAE,KAAR;AAAe,MAAA,SAAS,EAAE,KAAK,qBAAL,CAA2B,KAA3B;AAA1B,KAA/B;AACA,QAAI,UAAJ,EAAgB,KAAK,aAAL,CAAmB,UAAnB;AAChB,WAAO,IAAP;AACH,GAJD;AAMA;;;AAGG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,OAAA,GAAA,UAAQ,KAAR,EAAuD,UAAvD,EAAiF;AAC7E,SAAK,aAAL,CAAmB,MAAnB,CAA0B,IAA1B,CAA+B;AAAE,MAAA,IAAI,EAAE,IAAR;AAAc,MAAA,SAAS,EAAE,KAAK,qBAAL,CAA2B,KAA3B;AAAzB,KAA/B;AACA,QAAI,UAAJ,EAAgB,KAAK,aAAL,CAAmB,UAAnB;AAChB,WAAO,IAAP;AACH,GAJD;AAMA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,UAAA,GAAA,UAAW,GAAX,EAAyB;AACrB,WAAO,KAAK,KAAL,CAAW,KAAK,wBAAL,CAA8B,GAA9B,CAAX,CAAP;AACH,GAFD;AAIA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,aAAA,GAAA,UAAc,GAAd,EAA4B;AACxB,WAAO,KAAK,QAAL,CAAc,KAAK,wBAAL,CAA8B,GAA9B,CAAd,CAAP;AACH,GAFD;AAIA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,YAAA,GAAA,UAAa,GAAb,EAA2B;AACvB,WAAO,KAAK,OAAL,CAAa,KAAK,wBAAL,CAA8B,GAA9B,CAAb,CAAP;AACH,GAFD;AAoBA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,MAAA,GAAA,UAAO,MAAP,EAA8B;AAC1B,WAAO,KAAK,SAAL,CAAe,MAAf,CAAP;AACH,GAFD;AAqBA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,SAAA,GAAA,UAAU,SAAV,EAAoC;AAEhC;AACA,QAAI,CAAC,KAAK,UAAL,CAAgB,MAAhB,CAAuB,uBAAvB,EAAL,EACI,MAAM,IAAI,mCAAJ,EAAN;AAEJ,SAAK,aAAL,CAAmB,SAAnB,GAA+B,SAA/B;AACA,WAAO,IAAP;AACH,GARD;AAiCA;;;;AAIG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,OAAA,GAAA,UAAQ,IAAR,EAAwC,KAAxC,EAAqE,KAArE,EAAuG;;;AAA/D,QAAA,KAAA,KAAA,KAAA,CAAA,EAAA;AAAA,MAAA,KAAA,GAAA,KAAA;AAA2B;;AAC/D,QAAI,IAAJ,EAAU;AACN,UAAI,IAAI,YAAY,MAApB,EAA4B;AACxB,aAAK,aAAL,CAAmB,QAAnB,GAA8B,IAA9B;AACH,OAFD,MAEO;AACH,YAAI,KAAJ,EAAW;AACP,eAAK,aAAL,CAAmB,QAAnB,IAA2B,EAAA,GAAA,EAAA,EAAK,EAAA,CAAC,IAAD,CAAA,GAAkB;AAAE,YAAA,KAAK,EAAA,KAAP;AAAS,YAAA,KAAK,EAAA;AAAd,WAAvB,EAAuC,EAAlE;AACH,SAFD,MAEO;AACH,eAAK,aAAL,CAAmB,QAAnB,IAA2B,EAAA,GAAA,EAAA,EAAK,EAAA,CAAC,IAAD,CAAA,GAAkB,KAAvB,EAA4B,EAAvD;AACH;AACJ;AACJ,KAVD,MAUO;AACH,WAAK,aAAL,CAAmB,QAAnB,GAA8B,EAA9B;AACH;;AACD,WAAO,IAAP;AACH,GAfD;AAiBA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,UAAA,GAAA,UAAW,IAAX,EAAyB,KAAzB,EAAsD,KAAtD,EAAwF;AAA/D,QAAA,KAAA,KAAA,KAAA,CAAA,EAAA;AAAA,MAAA,KAAA,GAAA,KAAA;AAA2B;;AAChD,QAAI,KAAJ,EAAW;AACP,WAAK,aAAL,CAAmB,QAAnB,CAA4B,IAA5B,IAAoC;AAAE,QAAA,KAAK,EAAA,KAAP;AAAS,QAAA,KAAK,EAAA;AAAd,OAApC;AACH,KAFD,MAEO;AACH,WAAK,aAAL,CAAmB,QAAnB,CAA4B,IAA5B,IAAoC,KAApC;AACH;;AACD,WAAO,IAAP;AACH,GAPD;AASA;;AAEG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,KAAA,GAAA,UAAM,KAAN,EAAoB;AAChB,SAAK,aAAL,CAAmB,KAAnB,GAA2B,KAA3B;AACA,WAAO,IAAP;AACH,GAHD;AAKA;;;;AAIG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,WAAA,GAAA,UAAY,MAAZ,EAAmC;AAAnC,QAAA,KAAA,GAAA,IAAA;;AACI,QAAI,CAAC,KAAK,aAAL,CAAmB,SAAnB,CAA8B,WAAnC,EACI,MAAM,IAAI,KAAJ,CAAU,iFAAV,CAAN;AAEJ,SAAK,aAAL,CAAmB,MAAnB,GAA4B,EAA5B;AACA,QAAM,QAAQ,GAAa,KAAK,CAAC,OAAN,CAAc,MAAd,IAAwB,MAAxB,GAAiC,CAAC,MAAD,CAA5D;AACA,IAAA,QAAQ,CAAC,OAAT,CAAiB,UAAA,MAAA,EAAM;AAEnB,UAAM,WAAW,GAAG,KAAI,CAAC,aAAL,CAAmB,SAAnB,CAA8B,QAA9B,CAAuC,cAAvC,CAAsD,MAAtD,CAApB;;AACA,UAAI,CAAC,WAAL,EACI,MAAM,IAAI,KAAJ,CAAU,kEAAV,CAAN;;AAEJ,MAAA,KAAI,CAAC,YAAL,CAAkB,WAAlB;AACH,KAPD;AASA,SAAK,aAAL,CAAmB,aAAnB,GAAmC,QAAnC;AACA,WAAO,IAAP;AACH,GAjBD;AAmBA;;;;AAIG;;;AACH,EAAA,kBAAA,CAAA,SAAA,CAAA,YAAA,GAAA,UAAa,OAAb,EAA6B;AACzB,SAAK,aAAL,CAAmB,YAAnB,GAAkC,OAAlC;AACA,WAAO,IAAP;AACH,GAHD,CA7VJ,CAkWI;AACA;AACA;;AAEA;;AAEG;;;AACO,EAAA,kBAAA,CAAA,SAAA,CAAA,sBAAA,GAAV,YAAA;AAAA,QAAA,KAAA,GAAA,IAAA;;AACI,QAAM,SAAS,GAAG,KAAK,WAAL,EAAlB;AACA,QAAM,QAAQ,GAAG,KAAK,aAAL,CAAmB,SAAnB,CAA8B,WAA9B,GAA4C,KAAK,aAAL,CAAmB,SAAnB,CAA8B,QAA1E,GAAqF,SAAtG,CAFJ,CAII;;AACA,QAAM,qBAAqB,GAAa,EAAxC;AACA,QAAM,cAAc,GAAqB,EAAzC;AACA,QAAM,aAAa,GAAkB,EAArC;AACA,QAAI,eAAe,GAAK,KAAK,UAAL,CAAgB,MAAhB,YAAkC,WAAlC,IACA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,mBADlC,IAEA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,YAFlC,IAGA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,oBAHlC,IAIA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,SAJlC,GAKlB,CALkB,GAKd,MAAM,CAAC,IAAP,CAAY,KAAK,aAAL,CAAmB,gBAA/B,EAAiD,MAL3D;;AAMA,QAAI,QAAJ,EAAc;AACV,MAAA,cAAc,CAAC,kBAAf,CAAkC,QAAlC,EAA4C,SAA5C,EAAuD,OAAvD,CAA+D,UAAA,YAAA,EAAY;AACvE;AACA,YAAM,OAAO,GAAG,QAAQ,CAAC,2BAAT,CAAqC,YAArC,CAAhB;;AAEA,YAAI,OAAO,CAAC,MAAR,IAAkB,CAAtB,EAAyB;AACrB,gBAAM,IAAI,oBAAJ,CAAyB,YAAzB,CAAN;AACH;;AAED,QAAA,OAAO,CAAC,OAAR,CAAgB,UAAA,MAAA,EAAM;AAClB,cAAI,CAAC,MAAM,CAAC,QAAZ,EAAsB;AAAE;AAAS;;AACjC,UAAA,cAAc,CAAC,IAAf,CAAoB,MAApB;AAEA,cAAM,SAAS,GAAG,SAAS,MAAM,CAAC,YAAlC,CAJkB,CAMlB;;AACA,cAAI,KAAK,GAAG,MAAM,CAAC,cAAP,CAAsB,SAAtB,CAAZ;;AACA,cAAI,MAAM,CAAC,gBAAP,IAA2B,KAAK,YAAY,MAAhD,EAAwD;AACpD,YAAA,KAAK,GAAG,MAAM,CAAC,gBAAP,CAAwB,cAAxB,CAAuC,KAAvC,CAAR;AACH,WAFD,MAGK,IAAI,EAAE,KAAK,YAAY,QAAnB,CAAJ,EAAkC;AACnC,YAAA,KAAK,GAAG,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,sBAAvB,CAA8C,KAA9C,EAAqD,MAArD,CAAR;AACH,WAbiB,CAelB;;;AACA,cAAI,KAAK,YAAY,QAArB,EAA+B;AAAE;AAC7B,YAAA,qBAAqB,CAAC,IAAtB,CAA2B,KAAI,CAAC,MAAL,CAAY,MAAM,CAAC,YAAnB,IAAmC,KAAnC,GAA2C,KAAK,EAA3E;AACH,WAFD,MAEO,IAAI,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,SAAlC,IAA+C,KAAK,KAAK,IAA7D,EAAmE;AACtE,YAAA,qBAAqB,CAAC,IAAtB,CAA2B,KAAI,CAAC,MAAL,CAAY,MAAM,CAAC,YAAnB,IAAmC,SAA9D;AACH,WAFM,MAEA;AACH,gBAAI,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,eAAtC,EAAuD;AACnD,cAAA,KAAK,GAAG,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,gBAAvB,CAAwC,MAAxC,EAAgD,KAAhD,CAAR,CADmD,CAGvD;AACA;AACC;;AAED,gBAAI,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,WAAlC,IACA,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,mBADlC,IAEA,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,YAFlC,IAGA,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,oBAHlC,IAIA,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,SAJtC,EAIiD;AAC7C,cAAA,aAAa,CAAC,SAAD,CAAb,GAA2B,KAA3B;AACH,aAND,MAMO;AACH,cAAA,KAAI,CAAC,aAAL,CAAmB,gBAAnB,CAAoC,SAApC,IAAiD,KAAjD;AACH;;AAED,gBAAI,UAAU,GAAG,IAAjB;;AACA,gBAAI,CAAC,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,WAAlC,IAAiD,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,mBAApF,KAA4G,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,YAAvB,CAAoC,OAApC,CAA4C,MAAM,CAAC,IAAnD,MAA6D,CAAC,CAA9K,EAAiL;AAC7K,kBAAM,SAAS,GAAG,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,OAAvB,CAA+B,oBAAjD;AACA,kBAAM,YAAY,GAAG,SAAS,GAAG,cAAH,GAAoB,iBAAlD;;AACA,kBAAI,MAAM,CAAC,IAAP,IAAe,IAAnB,EAAyB;AACrB,gBAAA,UAAU,GAAM,YAAY,GAAA,GAAZ,GAAgB,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,eAAvB,CAAuC,SAAvC,EAAkD,eAAlD,CAAhB,GAAkF,IAAlF,GAAuF,MAAM,CAAC,IAA9F,GAAkG,GAAlH;AACH,eAFD,MAEO;AACH,gBAAA,UAAU,GAAM,YAAY,GAAA,GAAZ,GAAgB,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,eAAvB,CAAuC,SAAvC,EAAkD,eAAlD,CAAhB,GAAkF,GAAlG;AACH;AACJ,aARD,MAQO,IAAI,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,cAAlC,IAAoD,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,YAAvB,CAAoC,OAApC,CAA4C,MAAM,CAAC,IAAnD,MAA6D,CAAC,CAAtH,EAAyH;AAC5H,kBAAI,MAAM,CAAC,IAAP,IAAe,IAAnB,EAAyB;AACvB,gBAAA,UAAU,GAAG,mCAAiC,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,eAAvB,CAAuC,SAAvC,EAAkD,eAAlD,CAAjC,GAAmG,KAAnG,GAAyG,MAAM,CAAC,IAAhH,GAAoH,KAApH,GAA0H,MAAM,CAAC,IAA9I;AACD,eAFD,MAEO;AACL,gBAAA,UAAU,GAAG,wBAAsB,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,eAAvB,CAAuC,SAAvC,EAAkD,eAAlD,CAAtB,GAAwF,KAAxF,GAA8F,MAAM,CAAC,IAAlH;AACD;AACJ,aANM,MAMA,IAAI,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,eAAlC,IAAqD,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,YAAvB,CAAoC,OAApC,CAA4C,MAAM,CAAC,IAAnD,MAA6D,CAAC,CAAvH,EAA0H;AAC7H,cAAA,UAAU,GAAG,MAAM,CAAC,IAAP,GAAc,mBAAd,GAAoC,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,eAAvB,CAAuC,SAAvC,EAAkD,eAAlD,CAApC,GAAyG,IAAzG,IAAiH,MAAM,CAAC,IAAP,IAAe,GAAhI,IAAuI,GAApJ;AACH,aAFM,MAEA;AACH,cAAA,UAAU,GAAG,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,eAAvB,CAAuC,SAAvC,EAAkD,eAAlD,CAAb;AACH;;AACD,YAAA,qBAAqB,CAAC,IAAtB,CAA2B,KAAI,CAAC,MAAL,CAAY,MAAM,CAAC,YAAnB,IAAmC,KAAnC,GAA2C,UAAtE;AACA,YAAA,eAAe;AAClB;AACJ,SA7DD;AA8DH,OAtED;AAwEA,UAAI,QAAQ,CAAC,aAAT,IAA0B,cAAc,CAAC,OAAf,CAAuB,QAAQ,CAAC,aAAhC,MAAmD,CAAC,CAAlF,EACI,qBAAqB,CAAC,IAAtB,CAA2B,KAAK,MAAL,CAAY,QAAQ,CAAC,aAAT,CAAuB,YAAnC,IAAmD,KAAnD,GAA2D,KAAK,MAAL,CAAY,QAAQ,CAAC,aAAT,CAAuB,YAAnC,CAA3D,GAA8G,MAAzI;AACJ,UAAI,QAAQ,CAAC,gBAAT,IAA6B,cAAc,CAAC,OAAf,CAAuB,QAAQ,CAAC,gBAAhC,MAAsD,CAAC,CAAxF,EACI,qBAAqB,CAAC,IAAtB,CAA2B,KAAK,MAAL,CAAY,QAAQ,CAAC,gBAAT,CAA0B,YAAtC,IAAsD,sBAAjF,EA5EM,CA4EoG;AAEjH,KA9ED,MA8EO;AACH,MAAA,MAAM,CAAC,IAAP,CAAY,SAAZ,EAAuB,GAAvB,CAA2B,UAAA,GAAA,EAAG;AAC1B,YAAI,KAAK,GAAG,SAAS,CAAC,GAAD,CAArB,CAD0B,CAG1B;;AACA,YAAI,KAAK,YAAY,QAArB,EAA+B;AAAE;AAC7B,UAAA,qBAAqB,CAAC,IAAtB,CAA2B,KAAI,CAAC,MAAL,CAAY,GAAZ,IAAmB,KAAnB,GAA2B,KAAK,EAA3D;AACH,SAFD,MAEO,IAAI,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,SAAlC,IAA+C,KAAK,KAAK,IAA7D,EAAmE;AACtE,UAAA,qBAAqB,CAAC,IAAtB,CAA2B,KAAI,CAAC,MAAL,CAAY,GAAZ,IAAmB,SAA9C;AACH,SAFM,MAEA;AAEH;AACA;AACA;AAEA,cAAI,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,WAAlC,IACA,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,mBADlC,IAEA,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,YAFlC,IAGA,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,oBAHlC,IAIA,KAAI,CAAC,UAAL,CAAgB,MAAhB,YAAkC,SAJtC,EAIiD;AAC7C,YAAA,aAAa,CAAC,GAAD,CAAb,GAAqB,KAArB;AACH,WAND,MAMO;AACH,YAAA,KAAI,CAAC,aAAL,CAAmB,gBAAnB,CAAoC,GAApC,IAA2C,KAA3C;AACH;;AAED,UAAA,qBAAqB,CAAC,IAAtB,CAA2B,KAAI,CAAC,MAAL,CAAY,GAAZ,IAAmB,KAAnB,GAA2B,KAAI,CAAC,UAAL,CAAgB,MAAhB,CAAuB,eAAvB,CAAuC,GAAvC,EAA4C,eAA5C,CAAtD;AACA,UAAA,eAAe;AAClB;AACJ,OA3BD;AA4BH;;AAED,QAAI,qBAAqB,CAAC,MAAtB,IAAgC,CAApC,EAAuC;AACnC,YAAM,IAAI,wBAAJ,EAAN;AACH,KA7HL,CA+HI;AACA;;;AACA,QAAI,KAAK,UAAL,CAAgB,MAAhB,YAAkC,WAAlC,IACA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,mBADlC,IAEA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,YAFlC,IAGA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,oBAHlC,IAIA,KAAK,UAAL,CAAgB,MAAhB,YAAkC,SAJtC,EAIiD;AAC7C,WAAK,aAAL,CAAmB,gBAAnB,GAAsC,MAAM,CAAC,MAAP,CAAc,aAAd,EAA6B,KAAK,aAAL,CAAmB,gBAAhD,CAAtC;AACH,KAvIL,CAyII;;;AACA,QAAM,eAAe,GAAG,KAAK,qBAAL,EAAxB;AACA,QAAM,mBAAmB,GAAG,KAAK,yBAAL,EAA5B,CA3IJ,CA6II;;AACA,QAAI,mBAAmB,KAAK,KAAK,UAAL,CAAgB,MAAhB,YAAkC,cAAlC,IAAoD,KAAK,UAAL,CAAgB,MAAhB,YAAkC,YAAtF,IAAsG,KAAK,UAAL,CAAgB,MAAhB,YAAkC,eAA7I,CAAvB,EAAsL;AAClL,aAAO,YAAU,KAAK,YAAL,CAAkB,KAAK,gBAAL,EAAlB,CAAV,GAAoD,OAApD,GAA4D,qBAAqB,CAAC,IAAtB,CAA2B,IAA3B,CAA5D,GAA+F,eAA/F,GAA8G,aAA9G,GAA4H,mBAAnI;AAEH,KAHD,MAGO,IAAI,mBAAmB,IAAI,KAAK,UAAL,CAAgB,MAAhB,YAAkC,eAA7D,EAA8E;AACjF,aAAO,YAAU,KAAK,YAAL,CAAkB,KAAK,gBAAL,EAAlB,CAAV,GAAoD,OAApD,GAA4D,qBAAqB,CAAC,IAAtB,CAA2B,IAA3B,CAA5D,GAA4F,UAA5F,GAAuG,mBAAvG,GAA6H,eAApI;AAEH,KAHM,MAGA;AACH,aAAO,YAAU,KAAK,YAAL,CAAkB,KAAK,gBAAL,EAAlB,CAAV,GAAoD,OAApD,GAA4D,qBAAqB,CAAC,IAAtB,CAA2B,IAA3B,CAA5D,GAA+F,eAAtG,CADG,CACsH;AAC5H;AACJ,GAvJS;AAyJV;;AAEG;;;AACO,EAAA,kBAAA,CAAA,SAAA,CAAA,uBAAA,GAAV,YAAA;AAAA,QAAA,KAAA,GAAA,IAAA;;AACI,QAAM,QAAQ,GAAG,KAAK,aAAL,CAAmB,QAApC;AACA,QAAI,MAAM,CAAC,IAAP,CAAY,QAAZ,EAAsB,MAAtB,GAA+B,CAAnC,EACI,OAAO,eAAe,MAAM,CAAC,IAAP,CAAY,QAAZ,EACb,GADa,CACT,UAAA,UAAA,EAAU;AACX,UAAI,OAAO,QAAQ,CAAC,UAAD,CAAf,KAAgC,QAApC,EAA8C;AAC1C,eAAO,KAAI,CAAC,oBAAL,CAA0B,UAA1B,IAAwC,GAAxC,GAA8C,QAAQ,CAAC,UAAD,CAA7D;AACH,OAFD,MAEO;AACH,eAAO,KAAI,CAAC,oBAAL,CAA0B,UAA1B,IAAwC,GAAxC,GAA+C,QAAQ,CAAC,UAAD,CAAR,CAA6B,KAA5E,GAAoF,GAApF,GAA2F,QAAQ,CAAC,UAAD,CAAR,CAA6B,KAA/H;AACH;AACJ,KAPa,EAQb,IARa,CAQR,IARQ,CAAtB;AAUJ,WAAO,EAAP;AACH,GAdS;AAgBV;;AAEG;;;AACO,EAAA,kBAAA,CAAA,SAAA,CAAA,qBAAA,GAAV,YAAA;AACI,QAAI,KAAK,GAAqB,KAAK,aAAL,CAAmB,KAAjD;;AAEA,QAAI,KAAJ,EAAW;AACP,UAAI,KAAK,UAAL,CAAgB,MAAhB,YAAkC,WAAlC,IAAiD,KAAK,UAAL,CAAgB,MAAhB,YAAkC,mBAAvF,EAA4G;AACxG,eAAO,YAAY,KAAnB;AACH,OAFD,MAEO;AACH,cAAM,IAAI,8BAAJ,EAAN;AACH;AACJ;;AAED,WAAO,EAAP;AACH,GAZS;AAcV;;AAEG;;;AACO,EAAA,kBAAA,CAAA,SAAA,CAAA,WAAA,GAAV,YAAA;AACI,QAAI,KAAK,aAAL,CAAmB,SAAnB,YAAwC,MAA5C,EACI,OAAO,KAAK,aAAL,CAAmB,SAA1B;AAEJ,UAAM,IAAI,wBAAJ,EAAN;AACH,GALS;;AAOd,SAAA,kBAAA;AAAC,CAhjBD,CAAgD,YAAhD,CAAA","sourcesContent":["import {CockroachDriver} from \"../driver/cockroachdb/CockroachDriver\";\nimport {SapDriver} from \"../driver/sap/SapDriver\";\nimport {ColumnMetadata} from \"../metadata/ColumnMetadata\";\nimport {QueryBuilder} from \"./QueryBuilder\";\nimport {ObjectLiteral} from \"../common/ObjectLiteral\";\nimport {Connection} from \"../connection/Connection\";\nimport {QueryRunner} from \"../query-runner/QueryRunner\";\nimport {SqlServerDriver} from \"../driver/sqlserver/SqlServerDriver\";\nimport {PostgresDriver} from \"../driver/postgres/PostgresDriver\";\nimport {WhereExpression} from \"./WhereExpression\";\nimport {Brackets} from \"./Brackets\";\nimport {EntityMetadata} from \"../metadata/EntityMetadata\";\nimport {UpdateResult} from \"./result/UpdateResult\";\nimport {ReturningStatementNotSupportedError} from \"../error/ReturningStatementNotSupportedError\";\nimport {ReturningResultsEntityUpdator} from \"./ReturningResultsEntityUpdator\";\nimport {SqljsDriver} from \"../driver/sqljs/SqljsDriver\";\nimport {MysqlDriver} from \"../driver/mysql/MysqlDriver\";\nimport {BroadcasterResult} from \"../subscriber/BroadcasterResult\";\nimport {AbstractSqliteDriver} from \"../driver/sqlite-abstract/AbstractSqliteDriver\";\nimport {OrderByCondition} from \"../find-options/OrderByCondition\";\nimport {LimitOnUpdateNotSupportedError} from \"../error/LimitOnUpdateNotSupportedError\";\nimport {OracleDriver} from \"../driver/oracle/OracleDriver\";\nimport {UpdateValuesMissingError} from \"../error/UpdateValuesMissingError\";\nimport {EntityColumnNotFound} from \"../error/EntityColumnNotFound\";\nimport {QueryDeepPartialEntity} from \"./QueryPartialEntity\";\nimport {AuroraDataApiDriver} from \"../driver/aurora-data-api/AuroraDataApiDriver\";\nimport {BetterSqlite3Driver} from \"../driver/better-sqlite3/BetterSqlite3Driver\";\n\n/**\n * Allows to build complex sql queries in a fashion way and execute those queries.\n */\nexport class UpdateQueryBuilder<Entity> extends QueryBuilder<Entity> implements WhereExpression {\n\n    // -------------------------------------------------------------------------\n    // Constructor\n    // -------------------------------------------------------------------------\n\n    constructor(connectionOrQueryBuilder: Connection|QueryBuilder<any>, queryRunner?: QueryRunner) {\n        super(connectionOrQueryBuilder as any, queryRunner);\n        this.expressionMap.aliasNamePrefixingEnabled = false;\n    }\n\n    // -------------------------------------------------------------------------\n    // Public Implemented Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Gets generated sql query without parameters being replaced.\n     */\n    getQuery(): string {\n        let sql = this.createComment();\n        sql += this.createUpdateExpression();\n        sql += this.createOrderByExpression();\n        sql += this.createLimitExpression();\n        return sql.trim();\n    }\n\n    /**\n     * Executes sql generated by query builder and returns raw database results.\n     */\n    async execute(): Promise<UpdateResult> {\n        const queryRunner = this.obtainQueryRunner();\n        let transactionStartedByUs: boolean = false;\n\n        try {\n\n            // start transaction if it was enabled\n            if (this.expressionMap.useTransaction === true && queryRunner.isTransactionActive === false) {\n                await queryRunner.startTransaction();\n                transactionStartedByUs = true;\n            }\n\n            // call before updation methods in listeners and subscribers\n            if (this.expressionMap.callListeners === true && this.expressionMap.mainAlias!.hasMetadata) {\n                const broadcastResult = new BroadcasterResult();\n                queryRunner.broadcaster.broadcastBeforeUpdateEvent(broadcastResult, this.expressionMap.mainAlias!.metadata, this.expressionMap.valuesSet);\n                if (broadcastResult.promises.length > 0) await Promise.all(broadcastResult.promises);\n            }\n\n            let declareSql: string | null = null;\n            let selectOutputSql: string | null = null;\n\n            // if update entity mode is enabled we may need extra columns for the returning statement\n            const returningResultsEntityUpdator = new ReturningResultsEntityUpdator(queryRunner, this.expressionMap);\n            if (this.expressionMap.updateEntity === true &&\n                this.expressionMap.mainAlias!.hasMetadata &&\n                this.expressionMap.whereEntities.length > 0) {\n                this.expressionMap.extraReturningColumns = returningResultsEntityUpdator.getUpdationReturningColumns();\n\n                if (this.expressionMap.extraReturningColumns.length > 0 && this.connection.driver instanceof SqlServerDriver) {\n                    declareSql = this.connection.driver.buildTableVariableDeclaration(\"@OutputTable\", this.expressionMap.extraReturningColumns);\n                    selectOutputSql = `SELECT * FROM @OutputTable`;\n                }\n            }\n\n            // execute update query\n            const [updateSql, parameters] = this.getQueryAndParameters();\n            const updateResult = new UpdateResult();\n            const statements = [declareSql, updateSql, selectOutputSql];\n            const result = await queryRunner.query(\n                statements.filter(sql => sql != null).join(\";\\n\\n\"),\n                parameters,\n            );\n\n            if (this.connection.driver instanceof PostgresDriver) {\n                updateResult.raw = result[0];\n                updateResult.affected = result[1];\n            }\n            else if (this.connection.driver instanceof MysqlDriver) {\n                updateResult.raw = result;\n                updateResult.affected = result.affectedRows;\n            }\n            else if (this.connection.driver instanceof AuroraDataApiDriver) {\n                updateResult.raw = result;\n                updateResult.affected = result.numberOfRecordsUpdated;\n            }\n            else if (this.connection.driver instanceof BetterSqlite3Driver) { // only works for better-sqlite3\n                updateResult.raw = result;\n                updateResult.affected = result.changes;\n            }\n            else {\n                updateResult.raw = result;\n            }\n\n            // if we are updating entities and entity updation is enabled we must update some of entity columns (like version, update date, etc.)\n            if (this.expressionMap.updateEntity === true &&\n                this.expressionMap.mainAlias!.hasMetadata &&\n                this.expressionMap.whereEntities.length > 0) {\n                await returningResultsEntityUpdator.update(updateResult, this.expressionMap.whereEntities);\n            }\n\n            // call after updation methods in listeners and subscribers\n            if (this.expressionMap.callListeners === true && this.expressionMap.mainAlias!.hasMetadata) {\n                const broadcastResult = new BroadcasterResult();\n                queryRunner.broadcaster.broadcastAfterUpdateEvent(broadcastResult, this.expressionMap.mainAlias!.metadata);\n                if (broadcastResult.promises.length > 0) await Promise.all(broadcastResult.promises);\n            }\n\n            // close transaction if we started it\n            if (transactionStartedByUs)\n                await queryRunner.commitTransaction();\n\n            return updateResult;\n\n        } catch (error) {\n\n            // rollback transaction if we started it\n            if (transactionStartedByUs) {\n                try {\n                    await queryRunner.rollbackTransaction();\n                } catch (rollbackError) { }\n            }\n            throw error;\n\n        } finally {\n            if (queryRunner !== this.queryRunner) { // means we created our own query runner\n                await queryRunner.release();\n            }\n            if (this.connection.driver instanceof SqljsDriver && !queryRunner.isTransactionActive) {\n                await this.connection.driver.autoSave();\n            }\n        }\n    }\n\n    // -------------------------------------------------------------------------\n    // Public Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Values needs to be updated.\n     */\n    set(values: QueryDeepPartialEntity<Entity>): this {\n        this.expressionMap.valuesSet = values;\n        return this;\n    }\n\n    /**\n     * Sets WHERE condition in the query builder.\n     * If you had previously WHERE expression defined,\n     * calling this function will override previously set WHERE conditions.\n     * Additionally you can add parameters used in where expression.\n     */\n    where(where: string|((qb: this) => string)|Brackets|ObjectLiteral|ObjectLiteral[], parameters?: ObjectLiteral): this {\n        this.expressionMap.wheres = []; // don't move this block below since computeWhereParameter can add where expressions\n        const condition = this.computeWhereParameter(where);\n        if (condition)\n            this.expressionMap.wheres = [{ type: \"simple\", condition: condition }];\n        if (parameters)\n            this.setParameters(parameters);\n        return this;\n    }\n\n    /**\n     * Adds new AND WHERE condition in the query builder.\n     * Additionally you can add parameters used in where expression.\n     */\n    andWhere(where: string|((qb: this) => string)|Brackets, parameters?: ObjectLiteral): this {\n        this.expressionMap.wheres.push({ type: \"and\", condition: this.computeWhereParameter(where) });\n        if (parameters) this.setParameters(parameters);\n        return this;\n    }\n\n    /**\n     * Adds new OR WHERE condition in the query builder.\n     * Additionally you can add parameters used in where expression.\n     */\n    orWhere(where: string|((qb: this) => string)|Brackets, parameters?: ObjectLiteral): this {\n        this.expressionMap.wheres.push({ type: \"or\", condition: this.computeWhereParameter(where) });\n        if (parameters) this.setParameters(parameters);\n        return this;\n    }\n\n    /**\n     * Adds new AND WHERE with conditions for the given ids.\n     */\n    whereInIds(ids: any|any[]): this {\n        return this.where(this.createWhereIdsExpression(ids));\n    }\n\n    /**\n     * Adds new AND WHERE with conditions for the given ids.\n     */\n    andWhereInIds(ids: any|any[]): this {\n        return this.andWhere(this.createWhereIdsExpression(ids));\n    }\n\n    /**\n     * Adds new OR WHERE with conditions for the given ids.\n     */\n    orWhereInIds(ids: any|any[]): this {\n        return this.orWhere(this.createWhereIdsExpression(ids));\n    }\n    /**\n     * Optional returning/output clause.\n     * This will return given column values.\n     */\n    output(columns: string[]): this;\n\n    /**\n     * Optional returning/output clause.\n     * Returning is a SQL string containing returning statement.\n     */\n    output(output: string): this;\n\n    /**\n     * Optional returning/output clause.\n     */\n    output(output: string|string[]): this;\n\n    /**\n     * Optional returning/output clause.\n     */\n    output(output: string|string[]): this {\n        return this.returning(output);\n    }\n\n    /**\n     * Optional returning/output clause.\n     * This will return given column values.\n     */\n    returning(columns: string[]): this;\n\n    /**\n     * Optional returning/output clause.\n     * Returning is a SQL string containing returning statement.\n     */\n    returning(returning: string): this;\n\n    /**\n     * Optional returning/output clause.\n     */\n    returning(returning: string|string[]): this;\n\n    /**\n     * Optional returning/output clause.\n     */\n    returning(returning: string|string[]): this {\n\n        // not all databases support returning/output cause\n        if (!this.connection.driver.isReturningSqlSupported())\n            throw new ReturningStatementNotSupportedError();\n\n        this.expressionMap.returning = returning;\n        return this;\n    }\n\n    /**\n     * Sets ORDER BY condition in the query builder.\n     * If you had previously ORDER BY expression defined,\n     * calling this function will override previously set ORDER BY conditions.\n     *\n     * Calling order by without order set will remove all previously set order bys.\n     */\n    orderBy(): this;\n\n    /**\n     * Sets ORDER BY condition in the query builder.\n     * If you had previously ORDER BY expression defined,\n     * calling this function will override previously set ORDER BY conditions.\n     */\n    orderBy(sort: string, order?: \"ASC\"|\"DESC\", nulls?: \"NULLS FIRST\"|\"NULLS LAST\"): this;\n\n    /**\n     * Sets ORDER BY condition in the query builder.\n     * If you had previously ORDER BY expression defined,\n     * calling this function will override previously set ORDER BY conditions.\n     */\n    orderBy(order: OrderByCondition): this;\n\n    /**\n     * Sets ORDER BY condition in the query builder.\n     * If you had previously ORDER BY expression defined,\n     * calling this function will override previously set ORDER BY conditions.\n     */\n    orderBy(sort?: string|OrderByCondition, order: \"ASC\"|\"DESC\" = \"ASC\", nulls?: \"NULLS FIRST\"|\"NULLS LAST\"): this {\n        if (sort) {\n            if (sort instanceof Object) {\n                this.expressionMap.orderBys = sort as OrderByCondition;\n            } else {\n                if (nulls) {\n                    this.expressionMap.orderBys = { [sort as string]: { order, nulls } };\n                } else {\n                    this.expressionMap.orderBys = { [sort as string]: order };\n                }\n            }\n        } else {\n            this.expressionMap.orderBys = {};\n        }\n        return this;\n    }\n\n    /**\n     * Adds ORDER BY condition in the query builder.\n     */\n    addOrderBy(sort: string, order: \"ASC\"|\"DESC\" = \"ASC\", nulls?: \"NULLS FIRST\"|\"NULLS LAST\"): this {\n        if (nulls) {\n            this.expressionMap.orderBys[sort] = { order, nulls };\n        } else {\n            this.expressionMap.orderBys[sort] = order;\n        }\n        return this;\n    }\n\n    /**\n     * Sets LIMIT - maximum number of rows to be selected.\n     */\n    limit(limit?: number): this {\n        this.expressionMap.limit = limit;\n        return this;\n    }\n\n    /**\n     * Indicates if entity must be updated after update operation.\n     * This may produce extra query or use RETURNING / OUTPUT statement (depend on database).\n     * Enabled by default.\n     */\n    whereEntity(entity: Entity|Entity[]): this {\n        if (!this.expressionMap.mainAlias!.hasMetadata)\n            throw new Error(`.whereEntity method can only be used on queries which update real entity table.`);\n\n        this.expressionMap.wheres = [];\n        const entities: Entity[] = Array.isArray(entity) ? entity : [entity];\n        entities.forEach(entity => {\n\n            const entityIdMap = this.expressionMap.mainAlias!.metadata.getEntityIdMap(entity);\n            if (!entityIdMap)\n                throw new Error(`Provided entity does not have ids set, cannot perform operation.`);\n\n            this.orWhereInIds(entityIdMap);\n        });\n\n        this.expressionMap.whereEntities = entities;\n        return this;\n    }\n\n    /**\n     * Indicates if entity must be updated after update operation.\n     * This may produce extra query or use RETURNING / OUTPUT statement (depend on database).\n     * Enabled by default.\n     */\n    updateEntity(enabled: boolean): this {\n        this.expressionMap.updateEntity = enabled;\n        return this;\n    }\n\n    // -------------------------------------------------------------------------\n    // Protected Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Creates UPDATE express used to perform insert query.\n     */\n    protected createUpdateExpression() {\n        const valuesSet = this.getValueSet();\n        const metadata = this.expressionMap.mainAlias!.hasMetadata ? this.expressionMap.mainAlias!.metadata : undefined;\n\n        // prepare columns and values to be updated\n        const updateColumnAndValues: string[] = [];\n        const updatedColumns: ColumnMetadata[] = [];\n        const newParameters: ObjectLiteral = {};\n        let parametersCount =   this.connection.driver instanceof MysqlDriver ||\n                                this.connection.driver instanceof AuroraDataApiDriver ||\n                                this.connection.driver instanceof OracleDriver ||\n                                this.connection.driver instanceof AbstractSqliteDriver ||\n                                this.connection.driver instanceof SapDriver\n            ? 0 : Object.keys(this.expressionMap.nativeParameters).length;\n        if (metadata) {\n            EntityMetadata.createPropertyPath(metadata, valuesSet).forEach(propertyPath => {\n                // todo: make this and other query builder to work with properly with tables without metadata\n                const columns = metadata.findColumnsWithPropertyPath(propertyPath);\n\n                if (columns.length <= 0) {\n                    throw new EntityColumnNotFound(propertyPath);\n                }\n\n                columns.forEach(column => {\n                    if (!column.isUpdate) { return; }\n                    updatedColumns.push(column);\n\n                    const paramName = \"upd_\" + column.databaseName;\n\n                    //\n                    let value = column.getEntityValue(valuesSet);\n                    if (column.referencedColumn && value instanceof Object) {\n                        value = column.referencedColumn.getEntityValue(value);\n                    }\n                    else if (!(value instanceof Function)) {\n                        value = this.connection.driver.preparePersistentValue(value, column);\n                    }\n\n                    // todo: duplication zone\n                    if (value instanceof Function) { // support for SQL expressions in update query\n                        updateColumnAndValues.push(this.escape(column.databaseName) + \" = \" + value());\n                    } else if (this.connection.driver instanceof SapDriver && value === null) {\n                        updateColumnAndValues.push(this.escape(column.databaseName) + \" = NULL\");\n                    } else {\n                        if (this.connection.driver instanceof SqlServerDriver) {\n                            value = this.connection.driver.parametrizeValue(column, value);\n\n                        // } else if (value instanceof Array) {\n                        //     value = new ArrayParameter(value);\n                        }\n\n                        if (this.connection.driver instanceof MysqlDriver ||\n                            this.connection.driver instanceof AuroraDataApiDriver ||\n                            this.connection.driver instanceof OracleDriver ||\n                            this.connection.driver instanceof AbstractSqliteDriver ||\n                            this.connection.driver instanceof SapDriver) {\n                            newParameters[paramName] = value;\n                        } else {\n                            this.expressionMap.nativeParameters[paramName] = value;\n                        }\n\n                        let expression = null;\n                        if ((this.connection.driver instanceof MysqlDriver || this.connection.driver instanceof AuroraDataApiDriver) && this.connection.driver.spatialTypes.indexOf(column.type) !== -1) {\n                            const useLegacy = this.connection.driver.options.legacySpatialSupport;\n                            const geomFromText = useLegacy ? \"GeomFromText\" : \"ST_GeomFromText\";\n                            if (column.srid != null) {\n                                expression = `${geomFromText}(${this.connection.driver.createParameter(paramName, parametersCount)}, ${column.srid})`;\n                            } else {\n                                expression = `${geomFromText}(${this.connection.driver.createParameter(paramName, parametersCount)})`;\n                            }\n                        } else if (this.connection.driver instanceof PostgresDriver && this.connection.driver.spatialTypes.indexOf(column.type) !== -1) {\n                            if (column.srid != null) {\n                              expression = `ST_SetSRID(ST_GeomFromGeoJSON(${this.connection.driver.createParameter(paramName, parametersCount)}), ${column.srid})::${column.type}`;\n                            } else {\n                              expression = `ST_GeomFromGeoJSON(${this.connection.driver.createParameter(paramName, parametersCount)})::${column.type}`;\n                            }\n                        } else if (this.connection.driver instanceof SqlServerDriver && this.connection.driver.spatialTypes.indexOf(column.type) !== -1) {\n                            expression = column.type + \"::STGeomFromText(\" + this.connection.driver.createParameter(paramName, parametersCount) + \", \" + (column.srid || \"0\") + \")\";\n                        } else {\n                            expression = this.connection.driver.createParameter(paramName, parametersCount);\n                        }\n                        updateColumnAndValues.push(this.escape(column.databaseName) + \" = \" + expression);\n                        parametersCount++;\n                    }\n                });\n            });\n\n            if (metadata.versionColumn && updatedColumns.indexOf(metadata.versionColumn) === -1)\n                updateColumnAndValues.push(this.escape(metadata.versionColumn.databaseName) + \" = \" + this.escape(metadata.versionColumn.databaseName) + \" + 1\");\n            if (metadata.updateDateColumn && updatedColumns.indexOf(metadata.updateDateColumn) === -1)\n                updateColumnAndValues.push(this.escape(metadata.updateDateColumn.databaseName) + \" = CURRENT_TIMESTAMP\"); // todo: fix issue with CURRENT_TIMESTAMP(6) being used, can \"DEFAULT\" be used?!\n\n        } else {\n            Object.keys(valuesSet).map(key => {\n                let value = valuesSet[key];\n\n                // todo: duplication zone\n                if (value instanceof Function) { // support for SQL expressions in update query\n                    updateColumnAndValues.push(this.escape(key) + \" = \" + value());\n                } else if (this.connection.driver instanceof SapDriver && value === null) {\n                    updateColumnAndValues.push(this.escape(key) + \" = NULL\");\n                } else {\n\n                    // we need to store array values in a special class to make sure parameter replacement will work correctly\n                    // if (value instanceof Array)\n                    //     value = new ArrayParameter(value);\n\n                    if (this.connection.driver instanceof MysqlDriver ||\n                        this.connection.driver instanceof AuroraDataApiDriver ||\n                        this.connection.driver instanceof OracleDriver ||\n                        this.connection.driver instanceof AbstractSqliteDriver ||\n                        this.connection.driver instanceof SapDriver) {\n                        newParameters[key] = value;\n                    } else {\n                        this.expressionMap.nativeParameters[key] = value;\n                    }\n\n                    updateColumnAndValues.push(this.escape(key) + \" = \" + this.connection.driver.createParameter(key, parametersCount));\n                    parametersCount++;\n                }\n            });\n        }\n\n        if (updateColumnAndValues.length <= 0) {\n            throw new UpdateValuesMissingError();\n        }\n\n        // we re-write parameters this way because we want our \"UPDATE ... SET\" parameters to be first in the list of \"nativeParameters\"\n        // because some drivers like mysql depend on order of parameters\n        if (this.connection.driver instanceof MysqlDriver ||\n            this.connection.driver instanceof AuroraDataApiDriver ||\n            this.connection.driver instanceof OracleDriver ||\n            this.connection.driver instanceof AbstractSqliteDriver ||\n            this.connection.driver instanceof SapDriver) {\n            this.expressionMap.nativeParameters = Object.assign(newParameters, this.expressionMap.nativeParameters);\n        }\n\n        // get a table name and all column database names\n        const whereExpression = this.createWhereExpression();\n        const returningExpression = this.createReturningExpression();\n\n        // generate and return sql update query\n        if (returningExpression && (this.connection.driver instanceof PostgresDriver || this.connection.driver instanceof OracleDriver || this.connection.driver instanceof CockroachDriver)) {\n            return `UPDATE ${this.getTableName(this.getMainTableName())} SET ${updateColumnAndValues.join(\", \")}${whereExpression} RETURNING ${returningExpression}`;\n\n        } else if (returningExpression && this.connection.driver instanceof SqlServerDriver) {\n            return `UPDATE ${this.getTableName(this.getMainTableName())} SET ${updateColumnAndValues.join(\", \")} OUTPUT ${returningExpression}${whereExpression}`;\n\n        } else {\n            return `UPDATE ${this.getTableName(this.getMainTableName())} SET ${updateColumnAndValues.join(\", \")}${whereExpression}`; // todo: how do we replace aliases in where to nothing?\n        }\n    }\n\n    /**\n     * Creates \"ORDER BY\" part of SQL query.\n     */\n    protected createOrderByExpression() {\n        const orderBys = this.expressionMap.orderBys;\n        if (Object.keys(orderBys).length > 0)\n            return \" ORDER BY \" + Object.keys(orderBys)\n                    .map(columnName => {\n                        if (typeof orderBys[columnName] === \"string\") {\n                            return this.replacePropertyNames(columnName) + \" \" + orderBys[columnName];\n                        } else {\n                            return this.replacePropertyNames(columnName) + \" \" + (orderBys[columnName] as any).order + \" \" + (orderBys[columnName] as any).nulls;\n                        }\n                    })\n                    .join(\", \");\n\n        return \"\";\n    }\n\n    /**\n     * Creates \"LIMIT\" parts of SQL query.\n     */\n    protected createLimitExpression(): string {\n        let limit: number|undefined = this.expressionMap.limit;\n\n        if (limit) {\n            if (this.connection.driver instanceof MysqlDriver || this.connection.driver instanceof AuroraDataApiDriver) {\n                return \" LIMIT \" + limit;\n            } else {\n                throw new LimitOnUpdateNotSupportedError();\n            }\n        }\n\n        return \"\";\n    }\n\n    /**\n     * Gets array of values need to be inserted into the target table.\n     */\n    protected getValueSet(): ObjectLiteral {\n        if (this.expressionMap.valuesSet instanceof Object)\n            return this.expressionMap.valuesSet;\n\n        throw new UpdateValuesMissingError();\n    }\n\n}\n"],"sourceRoot":".."},"metadata":{},"sourceType":"module"}