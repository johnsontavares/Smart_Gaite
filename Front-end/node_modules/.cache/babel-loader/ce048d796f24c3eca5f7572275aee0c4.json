{"ast":null,"code":"import { RelationCountAttribute } from \"./RelationCountAttribute\";\n\nvar RelationCountMetadataToAttributeTransformer =\n/** @class */\nfunction () {\n  // -------------------------------------------------------------------------\n  // Constructor\n  // -------------------------------------------------------------------------\n  function RelationCountMetadataToAttributeTransformer(expressionMap) {\n    this.expressionMap = expressionMap;\n  } // -------------------------------------------------------------------------\n  // Public Methods\n  // -------------------------------------------------------------------------\n\n\n  RelationCountMetadataToAttributeTransformer.prototype.transform = function () {\n    // by example:\n    // post has relation count:\n    // @RelationCount(post => post.categories) categoryCount\n    // category has relation count\n    // @RelationCount(category => category.images) imageCount\n    // we load post and join category\n    // we expect post.categoryCount and post.category.imageCount to have relation counts\n    var _this = this; // first create relation count attributes for all relation count metadatas of the main selected object (post from example)\n\n\n    if (this.expressionMap.mainAlias) {\n      this.expressionMap.mainAlias.metadata.relationCounts.forEach(function (relationCount) {\n        var attribute = _this.metadataToAttribute(_this.expressionMap.mainAlias.name, relationCount);\n\n        _this.expressionMap.relationCountAttributes.push(attribute);\n      });\n    } // second create relation count attributes for all relation count metadatas of all joined objects (category from example)\n\n\n    this.expressionMap.joinAttributes.forEach(function (join) {\n      // ensure this join has a metadata, because relation count can only work for real orm entities\n      if (!join.metadata || join.metadata.isJunction) return;\n      join.metadata.relationCounts.forEach(function (relationCount) {\n        var attribute = _this.metadataToAttribute(join.alias.name, relationCount);\n\n        _this.expressionMap.relationCountAttributes.push(attribute);\n      });\n    });\n  }; // -------------------------------------------------------------------------\n  // Private Methods\n  // -------------------------------------------------------------------------\n\n\n  RelationCountMetadataToAttributeTransformer.prototype.metadataToAttribute = function (parentAliasName, relationCount) {\n    return new RelationCountAttribute(this.expressionMap, {\n      relationName: parentAliasName + \".\" + relationCount.relation.propertyName,\n      mapToProperty: parentAliasName + \".\" + relationCount.propertyName,\n      alias: relationCount.alias,\n      queryBuilderFactory: relationCount.queryBuilderFactory\n    });\n  };\n\n  return RelationCountMetadataToAttributeTransformer;\n}();\n\nexport { RelationCountMetadataToAttributeTransformer };","map":{"version":3,"sources":["../browser/src/query-builder/relation-count/RelationCountMetadataToAttributeTransformer.ts"],"names":[],"mappings":"AAEA,SAAQ,sBAAR,QAAqC,0BAArC;;AAEA,IAAA,2CAAA;AAAA;AAAA,YAAA;AAEI;AACA;AACA;AAEA,WAAA,2CAAA,CAAsB,aAAtB,EAAuD;AAAjC,SAAA,aAAA,GAAA,aAAA;AACrB,GAPL,CASI;AACA;AACA;;;AAEA,EAAA,2CAAA,CAAA,SAAA,CAAA,SAAA,GAAA,YAAA;AAEI;AACA;AACA;AACA;AACA;AACA;AACA;AARJ,QAAA,KAAA,GAAA,IAAA,CAAA,CAUI;;;AACA,QAAI,KAAK,aAAL,CAAmB,SAAvB,EAAkC;AAC9B,WAAK,aAAL,CAAmB,SAAnB,CAA6B,QAA7B,CAAsC,cAAtC,CAAqD,OAArD,CAA6D,UAAA,aAAA,EAAa;AACtE,YAAM,SAAS,GAAG,KAAI,CAAC,mBAAL,CAAyB,KAAI,CAAC,aAAL,CAAmB,SAAnB,CAA8B,IAAvD,EAA6D,aAA7D,CAAlB;;AACA,QAAA,KAAI,CAAC,aAAL,CAAmB,uBAAnB,CAA2C,IAA3C,CAAgD,SAAhD;AACH,OAHD;AAIH,KAhBL,CAkBI;;;AACA,SAAK,aAAL,CAAmB,cAAnB,CAAkC,OAAlC,CAA0C,UAAA,IAAA,EAAI;AAE1C;AACA,UAAI,CAAC,IAAI,CAAC,QAAN,IAAkB,IAAI,CAAC,QAAL,CAAc,UAApC,EACI;AAEJ,MAAA,IAAI,CAAC,QAAL,CAAc,cAAd,CAA6B,OAA7B,CAAqC,UAAA,aAAA,EAAa;AAC9C,YAAM,SAAS,GAAG,KAAI,CAAC,mBAAL,CAAyB,IAAI,CAAC,KAAL,CAAW,IAApC,EAA0C,aAA1C,CAAlB;;AACA,QAAA,KAAI,CAAC,aAAL,CAAmB,uBAAnB,CAA2C,IAA3C,CAAgD,SAAhD;AACH,OAHD;AAIH,KAVD;AAWH,GA9BD,CAbJ,CA6CI;AACA;AACA;;;AAEQ,EAAA,2CAAA,CAAA,SAAA,CAAA,mBAAA,GAAR,UAA4B,eAA5B,EAAqD,aAArD,EAAyF;AACrF,WAAO,IAAI,sBAAJ,CAA2B,KAAK,aAAhC,EAA+C;AAClD,MAAA,YAAY,EAAE,eAAe,GAAG,GAAlB,GAAwB,aAAa,CAAC,QAAd,CAAuB,YADX;AAElD,MAAA,aAAa,EAAE,eAAe,GAAG,GAAlB,GAAwB,aAAa,CAAC,YAFH;AAGlD,MAAA,KAAK,EAAE,aAAa,CAAC,KAH6B;AAIlD,MAAA,mBAAmB,EAAE,aAAa,CAAC;AAJe,KAA/C,CAAP;AAMH,GAPO;;AASZ,SAAA,2CAAA;AAAC,CA1DD,EAAA","sourcesContent":["import {QueryExpressionMap} from \"../QueryExpressionMap\";\nimport {RelationCountMetadata} from \"../../metadata/RelationCountMetadata\";\nimport {RelationCountAttribute} from \"./RelationCountAttribute\";\n\nexport class RelationCountMetadataToAttributeTransformer {\n\n    // -------------------------------------------------------------------------\n    // Constructor\n    // -------------------------------------------------------------------------\n\n    constructor(protected expressionMap: QueryExpressionMap) {\n    }\n\n    // -------------------------------------------------------------------------\n    // Public Methods\n    // -------------------------------------------------------------------------\n\n    transform() {\n\n        // by example:\n        // post has relation count:\n        // @RelationCount(post => post.categories) categoryCount\n        // category has relation count\n        // @RelationCount(category => category.images) imageCount\n        // we load post and join category\n        // we expect post.categoryCount and post.category.imageCount to have relation counts\n\n        // first create relation count attributes for all relation count metadatas of the main selected object (post from example)\n        if (this.expressionMap.mainAlias) {\n            this.expressionMap.mainAlias.metadata.relationCounts.forEach(relationCount => {\n                const attribute = this.metadataToAttribute(this.expressionMap.mainAlias!.name, relationCount);\n                this.expressionMap.relationCountAttributes.push(attribute);\n            });\n        }\n\n        // second create relation count attributes for all relation count metadatas of all joined objects (category from example)\n        this.expressionMap.joinAttributes.forEach(join => {\n\n            // ensure this join has a metadata, because relation count can only work for real orm entities\n            if (!join.metadata || join.metadata.isJunction)\n                return;\n\n            join.metadata.relationCounts.forEach(relationCount => {\n                const attribute = this.metadataToAttribute(join.alias.name, relationCount);\n                this.expressionMap.relationCountAttributes.push(attribute);\n            });\n        });\n    }\n\n    // -------------------------------------------------------------------------\n    // Private Methods\n    // -------------------------------------------------------------------------\n\n    private metadataToAttribute(parentAliasName: string, relationCount: RelationCountMetadata): RelationCountAttribute {\n        return new RelationCountAttribute(this.expressionMap, {\n            relationName: parentAliasName + \".\" + relationCount.relation.propertyName, // category.images\n            mapToProperty: parentAliasName + \".\" + relationCount.propertyName, // category.imageIds\n            alias: relationCount.alias,\n            queryBuilderFactory: relationCount.queryBuilderFactory\n        });\n    }\n\n}"],"sourceRoot":"../.."},"metadata":{},"sourceType":"module"}